<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment Page</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Meta Pixel Code -->
    <script>
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', '808518914545478');
      fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
      src="https://www.facebook.com/tr?id=808518914545478&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-MQ2K25VN');</script>
    <!-- End Google Tag Manager -->
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "nsotq330nv");
    </script>
    <script>
      window.dataLayer = window.dataLayer || [];

      function checkoutEvent() {
        const eventName = document.getElementById('eventName')?.value || '';
        const userName = document.getElementById('userName')?.value || '';
        const userPhone = document.getElementById('userPhone')?.value || '';
        const userEmail = document.getElementById('userEmail')?.value || '';
        const gotra = document.getElementById('gotra')?.value || '';
        const address = document.getElementById('address')?.value || '';
        const displayAmount = document.getElementById('displayAmount');
        const amount = displayAmount ? displayAmount.innerText : '0';

        dataLayer.push({
          'event': 'AddPaymentInfo',
          'eventName': eventName,
          'amount': amount,
          'currency': 'INR',
          'transactionId': generateTransactionId()
        });
        console.log('Event tracked:', {
          eventName: eventName,
          amount: amount,
          currency: 'INR',
          transactionId: generateTransactionId()
        });
      }

      function generateTransactionId() {
        return 'TXN' + Math.random().toString(36).substr(2, 9);
      }

      function setDefaultGotra() {
        if (document.getElementById("defaultGotra").checked) {
          document.getElementById("gotra").value = "Kashyap";
        } else {
          document.getElementById("gotra").value = "";
        }
      }
    </script>
    <style>
      body {
        font-family: "Roboto", sans-serif;
        background: linear-gradient(135deg, #f4f4f4 0%, #e0e0e0 100%);
        color: #333;
        margin: 0;
        padding: 1px;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background-image: url(/assets/img/landing-page/logo%20hindu.png);
        background-repeat: no-repeat;
        background-position: center;
        background-size: 25%;
        background-attachment: fixed;
      }
      .container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 5px 10px;
        width: 500px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      h1 {
        text-align: center;
        color: #a52a2a;
        font-size: 1.5em;
        margin-bottom: 5px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
      }
      h2 {
        margin-top: 2px;
        color: #a52a2a;
        font-size: 1.2em;
        text-align: center;
        font-weight: 600;
      }
      label {
        margin: 1px 0 1px;
        display: block;
        font-weight: 600;
        color: #444;
        font-size: 0.9em;
      }
      input[type="text"],
      input[type="tel"],
      input[type="email"] {
        width: 100%;
        padding: 6px 8px;
        margin: 1px 0 6px;
        border: 2px solid #ddd;
        border-radius: 10px;
        font-size: 0.8em;
        transition: all 0.3s ease;
        box-sizing: border-box;
      }
      input:focus {
        border-color: #a52a2a;
        outline: none;
        box-shadow: 0 0 0 3px rgba(165, 42, 42, 0.1);
      }
      button {
        background: linear-gradient(45deg, #a52a2a, #cc3333);
        color: white;
        border: none;
        padding: 8px 14px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 0.9em;
        width: 100%;
        font-weight: 600;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(165, 42, 42, 0.3);
      }
      #amountDisplay {
        color: #a52a2a;
        text-align: center;
        font-size: 1.2em;
        font-weight: bold;
        margin: 2px 0;
        padding: 6px;
        border-radius: 15px;
        background: linear-gradient(to right, #fff5f5, #fff);
        border: 2px solid rgba(165, 42, 42, 0.1);
      }
      #cartItemsDisplay {
        margin: 10px 0;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 10px;
        background: #fafafa;
      }
      #cartItemsDisplay table {
        width: 100%;
        border-collapse: collapse;
      }
      #cartItemsDisplay th, #cartItemsDisplay td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      #cartItemsDisplay th {
        background: #a52a2a;
        color: white;
      }
      #printReceiptButton {
        margin-top: 2px;
      }
      @media (max-width: 768px) {
        .container {
          width: 90%;
          max-width: 600px;
          padding: 5px;
        }
        body {
          background-size: 35%;
          padding: 1px;
        }
        h1 {
          font-size: 1.5em;
        }
        h2 {
          font-size: 1.2em;
        }
        input[type="text"],
        input[type="tel"],
        input[type="email"] {
          padding: 6px 8px;
        }
      }
      @media (max-width: 480px) {
        body {
          background-size: 50%;
          padding: 1px;
        }
        .container {
          width: 95%;
          min-height: 500px;
          padding: 10px;
          border-radius: 15px;
          margin: 20px 0;
        }
        h1 {
          font-size: 1em;
          margin-bottom: 2px;
        }
        h2 {
          font-size: 0.7em;
        }
        label {
          font-size: 0.9em;
          margin: 1px 0 1px;
        }
        input[type="text"],
        input[type="tel"],
        input[type="email"] {
          padding: 1px;
          font-size: 0.6em;
          margin: 1px 0 6px;
        }
        button {
          margin-top: 10vh;
          font-size: 0.9em;
        }
        #amountDisplay {
          font-size: 1.2em;
          padding: 5px;
          margin: 2px 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MQ2K25VN"
      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div class="container">
      <div id="amountDisplay">
        Amount to be paid: ₹<span id="displayAmount"></span>
      </div>
      <div id="cartItemsDisplay">
        <h3>Cart Items</h3>
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody id="cartItems"></tbody>
        </table>
      </div>
      <h2>Enter Your Details</h2>
      <form id="userDetailsForm">
        <label for="eventName">Event Name:</label>
        <input type="text" id="eventName" readonly />
        <label for="userName">Name:</label>
        <input type="text" id="userName" required />
        <label for="userPhone">Phone Number:</label>
        <input type="tel" id="phone" pattern="[0-9]{10}" required />
        <label for="userEmail">Email:</label>
        <input type="email" id="userEmail" required />
        <label for="gotra">Gotra:</label>
        <input type="text" id="gotra" />
        <div class="flex items-center gap-2">
          <label class="text-xs" for="defaultGotra">Don't know Gotra?
            <span class="text-xs">(गोत्र नहीं पता?)</span>
          </label>
          <input type="checkbox" id="defaultGotra" onclick="setDefaultGotra()">
        </div>
        <label for="address">Address:</label>
        <input type="text" id="address" required />
        <button onclick="checkoutEvent()" class="bg-orange-500 mt-10 text-white px-4 py-2 rounded-md" type="submit">Pay Now</button>
        <button class="bg-green-500 text-white px-4 py-2 rounded-md" id="payButton" style="display: none">
          Print Payment Receipt
        </button>
      </form>
    </div>
    <script>
      // Load amount and event name from localStorage
      const amount = localStorage.getItem('totalAmount');
      if (amount) {
        document.getElementById("displayAmount").innerText = amount;
      }
      const eventName = localStorage.getItem('package');
      if (eventName) {
        document.getElementById("eventName").value = eventName;
      }

      // Load cart items from localStorage
      const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [
        { itemName: "Puja Item 1", quantity: 2, price: 100.00 },
        { itemName: "Puja Item 2", quantity: 1, price: 300.00 }
      ];

      // Display cart items
      const cartTable = document.getElementById('cartItems');
      cartItems.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.itemName}</td>
          <td>${item.quantity}</td>
          <td>₹${item.price.toFixed(2)}</td>
          <td>₹${(item.quantity * item.price).toFixed(2)}</td>
        `;
        cartTable.appendChild(row);
      });

      async function createOrder(amount) {
        try {
          const response = await fetch('create_order.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount: amount })
          });
          const result = await response.json();
          if (!result.success) {
            throw new Error(result.message || 'Failed to create order');
          }
          return result.order_id;
        } catch (error) {
          throw new Error(`Order creation failed: ${error.message}`);
        }
      }

      document.getElementById("userDetailsForm").onsubmit = async function(event) {
        event.preventDefault();
        const userName = document.getElementById("userName").value;
        const userPhone = document.getElementById("phone").value;
        const userEmail = document.getElementById("userEmail").value;
        const gotra = document.getElementById("gotra").value;
        const address = document.getElementById("address").value;
        const date = new Date().toISOString().slice(0, 19).replace('T', ' ');
        const displayAmount = document.getElementById("displayAmount").innerText;
        const amount = parseFloat(displayAmount);
        const razorpayApiKey = "rzp_live_UcnCYzIPLHdtGJ"; // Replace with your Razorpay API Key

        // Validate amount
        if (isNaN(amount) || amount <= 0) {
          alert("Invalid amount. Please check and try again.");
          return;
        }

        const payButton = document.querySelector('button[type="submit"]');
        payButton.innerText = 'Processing...';
        payButton.disabled = true;

        try {
          // Create Razorpay order
          const orderId = await createOrder(amount);

          const options = {
            key: razorpayApiKey,
            amount: amount * 100, // Convert to paise
            currency: "INR",
            name: "Hindu Mandir Puja",
            description: `Payment for event: ${eventName}`,
            order_id: orderId,
            handler: async function (response) {
              payButton.innerText = 'Saving...';
              const paymentData = {
                eventName,
                name: userName,
                email: userEmail,
                phone: userPhone,
                gotra,
                address,
                date,
                amount,
                paymentStatus: 'complete',
                paymentId: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature,
                cartItems
              };

              try {
                sessionStorage.setItem('paymentData', JSON.stringify(paymentData));
                await saveToDatabase(paymentData);
                window.location.href = 'thankyou.html';
              } catch (error) {
                console.error("Error saving data:", error.message);
                alert(`Error saving payment data: ${error.message}`);
                payButton.innerText = 'Pay Now';
                payButton.disabled = false;
              }
            },
            prefill: {
              name: userName,
              email: userEmail,
              contact: userPhone
            },
            theme: {
              color: "#772d9f"
            }
          };

          const razorpay = new Razorpay(options);
          razorpay.open();

          razorpay.on('payment.failed', function (response) {
            const paymentData = {
              eventName,
              name: userName,
              email: userEmail,
              phone: userPhone,
              gotra,
              address,
              date,
              amount,
              paymentStatus: 'failed',
              paymentId: response.error.metadata?.payment_id || "N/A",
              razorpay_order_id: response.error.metadata?.order_id || "N/A",
              razorpay_signature: null,
              cartItems
            };

            saveToDatabase(paymentData)
              .then(() => {
                console.log("Failed payment data saved to database.");
              })
              .catch(error => {
                console.error("Error saving failed payment data:", error.message);
              });

            alert(`Payment failed: ${response.error?.description || "Unknown error"}`);
            payButton.innerText = 'Pay Now';
            payButton.disabled = false;
          });
        } catch (error) {
          console.error("Payment initiation failed:", error.message);
          alert(`Error initiating payment: ${error.message}`);
          payButton.innerText = 'Pay Now';
          payButton.disabled = false;
        }
      };

      function saveToDatabase(data) {
        return new Promise((resolve, reject) => {
          fetch('save_payment.php', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          })
            .then(response => response.json())
            .then(result => {
              if (result.success) {
                console.log("Data saved to database successfully.");
                resolve();
              } else {
                throw new Error(result.message || "Failed to save data to database");
              }
            })
            .catch(error => {
              console.error("Error saving to database:", error.message);
              reject(error);
            });
        });
      }
    </script>
  </body>
</html>